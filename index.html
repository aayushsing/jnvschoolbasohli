<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>JNV Basohli ‚Äì Student Management (App Mode)</title>

<!-- App-like font & icons (no external JS frameworks) -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0f14;
  --card:#121826;
  --muted:#93a4b7;
  --text:#e6efff;
  --brand:#00e5ff;
  --brand2:#7a5cff;
  --danger:#ff4d4d;
  --ok:#39d98a;
  --warn:#ffb020;
  --stroke:rgba(255,255,255,0.06);
  --glow:0 0 0 1px rgba(122,92,255,0.15), 0 12px 30px -10px rgba(0,229,255,0.25);
  --radius:16px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:radial-gradient(1200px 700px at 10% -10%, rgba(0,229,255,0.06), transparent 60%), radial-gradient(1000px 600px at 110% -20%, rgba(122,92,255,0.06), transparent 60%), var(--bg);
  color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; line-height:1.45;
}

/* Top App Bar */
.appbar{
  position:sticky; top:0; z-index:1000; backdrop-filter:saturate(180%) blur(10px);
  background:linear-gradient(180deg, rgba(11,15,20,0.9), rgba(11,15,20,0.6));
  border-bottom:1px solid var(--stroke);
  display:flex; align-items:center; gap:12px; padding:10px 14px;
}
.appbar .logo{
  width:40px; height:40px; border-radius:12px; overflow:hidden; display:grid; place-items:center;
  background:linear-gradient(135deg, rgba(0,229,255,0.2), rgba(122,92,255,0.2));
  box-shadow:inset 0 0 0 1px var(--stroke);
}
.appbar .logo img{width:28px; height:28px; border-radius:8px; object-fit:cover}
.appbar h1{font-size:1.05rem; margin:0; font-weight:700; letter-spacing:0.2px}
.appbar .spacer{flex:1}
.badge{
  font-size:.75rem; padding:4px 8px; border-radius:999px; color:#00131a;
  background:linear-gradient(180deg, var(--brand), #00c2d6); font-weight:700;
  box-shadow:var(--glow);
}

/* Layout */
#app{display:none}
.container{padding:16px; max-width:1100px; margin:0 auto}

/* Drawer (sidebar) */
.drawer{
  position:fixed; top:56px; left:0; bottom:0; width:300px; max-width:85vw;
  background:rgba(18,24,38,0.9); backdrop-filter: blur(10px);
  border-right:1px solid var(--stroke);
  transform:translateX(-101%); transition:transform .25s ease; z-index:999;
}
.drawer.open{transform:translateX(0)}
.drawer .group{padding:14px}
.drawer h4{margin:8px 8px 12px; font-size:.9rem; color:var(--muted); font-weight:600}
.drawer button, .toolbar-btn{
  width:100%; text-align:left; background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  border:1px solid var(--stroke); color:var(--text); padding:12px 12px; margin:8px 0; border-radius:12px; cursor:pointer;
  font-weight:600; transition:all .2s ease; display:flex; align-items:center; gap:10px;
}
.drawer button:hover{box-shadow:var(--glow); transform:translateY(-1px)}
.toolbar{
  display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 2px;
}
.toolbar .toolbar-btn{width:auto; display:inline-flex; border-radius:999px; padding:10px 12px}

/* Search & filters */
.filters{
  display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 16px;
}
input,select,button{
  background:rgba(255,255,255,0.04); border:1px solid var(--stroke); color:var(--text);
  padding:10px 12px; border-radius:12px; outline:none; font-size:.95rem;
}
input::placeholder{color:#7e8da0}
button.primary{
  background:linear-gradient(90deg, var(--brand), var(--brand2)); border:none; color:#00131a;
  font-weight:800; letter-spacing:.2px; box-shadow:var(--glow); cursor:pointer;
}
button.ghost{background:transparent}
button.warn{background:linear-gradient(90deg, #ff7750, #ff4d4d); border:none; color:#200}
button.ok{background:linear-gradient(90deg, #39d98a, #12b886); border:none; color:#002412}

/* Cards grid with virtualized pagination */
.grid{
  display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:14px;
}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  border:1px solid var(--stroke); border-radius:var(--radius); padding:14px; box-shadow:var(--glow); min-height:120px;
}
.card .avatar{
  width:68px; height:68px; border-radius:50%; background:linear-gradient(135deg, rgba(0,229,255,.2), rgba(122,92,255,.2));
  display:grid; place-items:center; overflow:hidden; border:1px solid var(--stroke); margin-bottom:8px;
}
.card .avatar img{width:100%; height:100%; object-fit:cover}
.card h3{margin:6px 0 2px; font-size:1.02rem}
.meta{font-size:.86rem; color:var(--muted)}
.kv{display:grid; grid-template-columns:90px 1fr; gap:6px; font-size:.9rem; margin:8px 0}
.kv div:nth-child(odd){color:var(--muted)}
.actions{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}

/* Tables */
.table{width:100%; border-collapse:collapse; background:rgba(255,255,255,0.02); border:1px solid var(--stroke); border-radius:12px; overflow:hidden}
.table th,.table td{border-bottom:1px solid var(--stroke); padding:10px; text-align:left; font-size:.92rem}
.table th{color:#b8c7da; background:rgba(255,255,255,0.03)}
.table tr:last-child td{border-bottom:none}

/* Sections */
.section{display:none; margin-top:10px}
.section.active{display:block}

/* Login card */
#loginView{
  min-height:100vh; display:grid; place-items:center; padding:20px;
  background:
    radial-gradient(600px 300px at 10% 0%, rgba(122,92,255,0.18), transparent 60%),
    radial-gradient(700px 300px at 90% 0%, rgba(0,229,255,0.18), transparent 60%), var(--bg);
}
.login-card{
  width:min(420px, 92vw); background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
  border:1px solid var(--stroke); border-radius:20px; padding:20px 18px; box-shadow:var(--glow)
}
.login-card h2{margin:6px 2px 2px}
.helper{font-size:.9rem; color:var(--muted); margin:2px 2px 12px}
.row{display:flex; gap:8px; flex-wrap:wrap}
.row>*{flex:1}

/* Pills */
.pills{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
.pill{font-size:.75rem; border:1px solid var(--stroke); padding:6px 8px; border-radius:999px; color:var(--muted)}

/* Footer note */
.note{font-size:.85rem; color:var(--muted); margin-top:8px}

/* Floating drawer button */
.menu-btn{
  border-radius:12px; border:1px solid var(--stroke); background:rgba(255,255,255,0.04);
  padding:8px 10px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; font-weight:700;
}
.menu-btn:hover{box-shadow:var(--glow)}

/* Hidden utility */
.hidden{display:none !important}

/* Load more */
.loadmore{margin:16px auto; display:block}

/* Responsive tighten */
@media (max-width: 560px){
  .kv{grid-template-columns:82px 1fr}
}
/* --- Logo: smaller & circular --- */
.appbar .logo,
.login-card .logo,
.logo{
  width: 32px !important;
  height: 32px !important;
  border-radius: 50% !important;
}
.appbar .logo img,
.login-card .logo img,
.logo img{
  width: 24px !important;
  height: 24px !important;
  border-radius: 50% !important;
  object-fit: cover !important;
}

/* --- App bar title: prevent overflow on mobile --- */
.appbar h1{
  font-size: .98rem; 
  margin: 0; 
  font-weight: 700; 
  letter-spacing: .2px;
  max-width: 55vw;           /* keep it from pushing controls off-screen */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* --- Mobile fit & readability tweaks --- */
@media (max-width: 480px){
  .container{ padding: 12px; }
  .appbar{ padding: 8px 10px; }
  .appbar h1{ font-size: .9rem; max-width: 52vw; }
  .menu-btn{ padding: 6px 8px; font-size: .9rem; }
  .badge{ font-size: .7rem; padding: 3px 7px; }

  .login-card{ width: 95vw; padding: 16px 14px; }
  .login-card h2{ font-size: 1rem; line-height: 1.2; }
  input, select, button{ font-size: .9rem; padding: 9px 10px; }

  /* Cards compress a bit better */
  .grid{ grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
  .card{ padding: 12px; }
  .card .avatar{ width: 58px; height: 58px; }

  /* Filters wrap tighter without overflowing */
  .filters{ gap: 8px; }

  /* Drawer a hair narrower on tiny screens */
  .drawer{ width: 280px; }
}
  /* --- Small running name (marquee) next to "Signed in as" --- */
.ticker{
  display:inline-flex; align-items:center; gap:8px;
  border:1px solid var(--stroke); border-radius:999px;
  padding:6px 10px; margin-left:8px;
  max-width:420px; overflow:hidden; background:rgba(255,255,255,0.04);
}
.ticker span{
  display:inline-block; white-space:nowrap; padding-left:100%;
  animation:ticker-move 14s linear infinite;
  font-size:.86rem; color:var(--muted);
}
@keyframes ticker-move{ to { transform: translateX(-100%); } }

/* Mobile sizing for the running name */
@media (max-width:480px){
  .ticker{ max-width:58vw; padding:5px 8px; }
  .ticker span{ font-size:.8rem; }
}



</style>
</head>
</script>
<body>

<!-- LOGIN VIEW -->
<section id="loginView">
  <div class="login-card">
    <div style="display:flex; align-items:center; gap:10px">
      <div class="logo"><img src="jnv image.jpg" alt="JNV"></div>
      <div>
        <h2>JNV Basohli ‚Äì Student Management</h2>
      </div>
    </div>

    <label>Email / Admission No</label>
    <input id="email" placeholder="e.g. sankalp@gmail.com or JNVT001" autocomplete="username" />
    <div class="row">
      <div style="flex:2">
        <label>Password</label>
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
      </div>
      <div style="flex:1; display:flex; align-items:flex-end">
        <button class="primary" style="width:100%" id="loginBtn">Login</button>
      </div>
    </div>
  </div>
</section>

<!-- APP VIEW -->
<section id="app">
  <!-- App Bar -->
  <div class="appbar">
    <button class="menu-btn" id="openDrawerBtn">‚ò∞ Menu</button>
    <div class="logo"><img src="jnv image.jpg" alt="JNV"></div>
    <h1>JNV Basohli</h1>
    <div class="spacer"></div>
    <span id="roleBadge" class="badge">ROLE</span>
    <button id="logoutBtn" class="toolbar-btn">Logout</button>
  </div>

  <!-- Drawer -->
  <aside class="drawer" id="drawer">
    <div class="group">
      <h4>Navigate</h4>
      <button data-section="students">üë• Students</button>
      <button data-section="leaveManagement" class="rbac r-teacher1">üìù Leave Management</button>
      <button data-section="timetable" class="rbac r-teacher2">üìÖ Timetable</button>
      <button data-section="hostelTasks" class="rbac r-teacher1">üè† Hostel Tasks</button>

      <!-- Student Verification Card ‚Äì visible to Teacher1 only -->
      <button id="verificationBtn" class="rbac r-teacher1" onclick="window.open('https://aayushsing.github.io/Student-Verification-System/','_blank')">ü™™ Student Verification Card</button>
    </div>
    <div class="group">
      <h4>Data</h4>
      <button id="uploadBtn" class="rbac r-teacher1">‚¨ÜÔ∏è Upload Students Excel</button>
      <input type="file" id="uploadExcel" accept=".xlsx,.xls" class="hidden">
      <button id="exportStudentsBtn" class="rbac r-teacher1 r-teacher2">‚¨áÔ∏è Export Students</button>
      <!-- NEW BUTTON: Load Student Data (placed at bottom of sidebar group as requested) -->
      <button id="loadStudentDataBtn">üì• Load Student Data</button>
    </div>
  </aside>

  <main class="container">
    <!-- Toolbar -->
    <div class="toolbar">
      <div id="whoami" class="pill">Signed in as: <span id="whoamiText">‚Äî</span></div>
      <div class="ticker" aria-label="School name">
  <span>Pm Shri Jawahar Navodaya Vidyalaya Basohli pincode 184201 ‚Ä¢ Pm Shri Jawahar Navodaya Vidyalaya Basohli pincode 184201 ‚Ä¢ </span>
</div>

    </div>

    <!-- Students -->
    <section id="students" class="section active">
      <h2>Students</h2>
      <div class="filters">
        <input id="studentSearch" placeholder="Search by name or admission no" />
        <select id="hostelFilter">
          <option value="">All Hostels</option>
          <option>Aravali</option>
          <option>Nilgiri</option>
          <option>Shivalik</option>
          <option>Udaigiri</option>
        </select>
        <select id="houseFilter">
          <option value="">All Houses</option>
          <option>Blue</option>
          <option>Red</option>
          <option>Green</option>
          <option>Yellow</option>
        </select>
      </div>
      <div id="studentGrid" class="grid" aria-live="polite"></div>
      <button id="loadMoreBtn" class="toolbar-btn loadmore hidden">Load more</button>
    </section>

    <!-- Leave Management -->
    <section id="leaveManagement" class="section">
      <h2>Leave Management</h2>
      <div class="filters">
        <input id="leaveSearchInput" placeholder="Search student by Admission No or Name" />
        <select id="leaveStudent"></select>
        <div class="pill">Type:</div>
        <label class="pill"><input type="radio" name="leaveType" value="partial" checked> Partial</label>
        <label class="pill"><input type="radio" name="leaveType" value="full"> Full Day</label>
      </div>
      <div class="filters">
        <input type="date" id="leaveFrom">
        <input type="date" id="leaveTo">
        <input type="text" id="leaveReason" placeholder="Reason" />
        <input type="text" id="leaveParent" placeholder="Parent Name" />
        <button id="applyLeaveBtn" class="primary">Apply Leave</button>
        <button id="downloadLeaveHistoryBtn" class="toolbar-btn">Export Leave History</button>
      </div>
      <table id="leaveHistory" class="table"></table>
    </section>

    <!-- Timetable -->
    <section id="timetable" class="section">
      <h2>Timetable</h2>
      <div class="filters">
        <select id="ttClass">
          <option>6-A</option><option>6-B</option>
          <option>7-A</option><option>7-B</option>
          <option>8-A</option><option>8-B</option>
          <option>9-A</option><option>9-B</option>
          <option>10-A</option><option>10-B</option>
          <option>11-A</option><option>11-B</option>
          <option>12-A</option><option>12-B</option>
        </select>
        <input type="date" id="ttDate">
        <input type="time" id="ttTime">
        <input type="text" id="ttTopic" placeholder="Topic">
        <input type="text" id="ttTeacher" placeholder="Teacher Name">
        <button id="addTimetableBtn" class="primary rbac r-teacher2">Add</button>
        <button id="downloadTimetableBtn" class="toolbar-btn">Export Timetable</button>
      </div>
      <table id="timetableTable" class="table"></table>
    </section>

    <!-- Hostel Tasks -->
    <section id="hostelTasks" class="section">
      <h2>Hostel Tasks Management</h2>
      <div class="filters">
        <select id="taskHostel">
          <option>Aravali</option>
          <option>Nilgiri</option>
          <option>Shivalik</option>
          <option>Udaigiri</option>
        </select>
        <input type="date" id="taskDate">
        <input type="text" id="taskDesc" placeholder="Task Description">
        <button id="addTaskBtn" class="primary">Add Task</button>
        <button id="downloadTasksBtn" class="toolbar-btn">Export Tasks</button>
      </div>
      <table id="taskTable" class="table"></table>
    </section>
  </main>
</section>

<!-- XLSX for import/export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* ==========================
   DATA (demo only ‚Äì replace with server in production)
========================== */
const users = [
  {email:"sankalp@gmail.com",   password:"1234", role:"teacher1", name:"Sankalp"},
  {email:"reetwik@gmail.com",   password:"4321", role:"teacher1", name:"Reetwik"},
  {email:"kalyani@gmail.com",   password:"98745",role:"teacher2", name:"Kalyani"},
  {email:"aayush@gmail.com",    password:"1234", role:"student",  admissionNo:"2912", name:"HARI NITHAR"},
  {email:"rohan@gmail.com",     password:"1234", role:"student",  admissionNo:"JNVT002", name:"Rohan Sharma"},
  {email:"priya@gmail.com",     password:"1234", role:"student",  admissionNo:"JNVT003", name:"Priya Verma"},
  {email:"parent@gmail.com",    password:"1234", role:"parent",   admissionNo:"JNVT001", name:"Parent of Aayush"}
];

let students = JSON.parse(localStorage.getItem("students_seed_v2") || "[]");
if(students.length === 0){
  students = [
    {admissionNo:"2912",name:"HARI NIHAR",class:"IX A",hostel:"Aravali",phone:"7780851610",email:"harinihar@gmail.com",img:"",fatherName:"SANJEEV KUMAR",motherName:"MEENIKSHI MEHRA",address:"V.P.O BHADDU TESHIL BILLAWAR DIST KATHU"},
    {admissionNo:"2904",name:"MOHIT KUMAR",class:"IX A",hostel:"Aravali",house:"",phone:"7889519688",email:"mohitkumar@gmail.com",img:"",fatherName:"SHAM LAL",motherName:"TOSHI DEVI",address:"V.P.O JARNOTA TESHIL BASOHLI DIST KATHUA"},
    {admissionNo:"2960",name:"SHARAB AHMED MALIK",class:"IX A",hostel:"Aravali",house:"",phone:"7006458872",email:"sharabahmedmalik@gmail.com",img:"",fatherName:"SHABIR AHMED",motherName:"BUSHRAY BEGUM",address:"VILLAGE BADNOTA TEH LOHAI MALHAR,DIST KATHUA"},
    {admissionNo:"2891",name:"SPARSH SINGH",class:"IX A",hostel:"Aravali",house:"",phone:"7006195102",email:"sparshsingh@gmail.com",img:"",fatherName:"RAJENDAR",motherName:"RANJANA PUNIA",address:"VILLAGE KALARI TESHIL KATHUA DIST KATHUA"},
    {admissionNo:"2917",name:"SUDHANSHU SONI",class:"IX A",hostel:"Aravali",house:"",phone:"9541344600",email:"sudhanshusoni@gmail.com",img:"",fatherName:"MANGU RAM",motherName:"SUSHMA DEVI",address:"V.P.O PANDORI,TEHSIL NAGRI PAROLE,DISTRICT KATHUA,JAMMU &KASHMIR,"},
    {admissionNo:"2875",name:"VANSHIK MANKOTIA",class:"IX A",hostel:"Aravali",house:"",phone:"9622129129",email:"vanshikmankotia@gmail.com",img:"",fatherName:"GURDEV SINGH",motherName:"SHILPY RAJPUT",address:"VILLAGE BAKTHPUR TESHIL BILLAWAR DIST KATHUA"},
    {admissionNo:"4054",name:"DAKSH VERMA",class:"IX A",hostel:"Aravali",house:"",phone:"9622492267",email:"dakshverma@gmail.com",img:"",fatherName:"SATISHKUMAR",motherName:"RANIDEVI",address:"V.P.O JARNOTA TESHIL BASOHLI DIST KATHUA"},
    {admissionNo:"4056",name:"PRINCE VERMA",class:"IX B",hostel:"Aravali",house:"",phone:"9622218975",email:"princeverma@gmail.com",img:"",fatherName:" MINTU KUMAR",motherName:" POONAM DEVI",address:"VILL. DRAMAN, TEHSIL BASOHLI, P/O DRAMAN,KATHUA, J&K, 184201"},
    {admissionNo:"2840",name:"DHEERAJ SHARMA",class:"X A",hostel:"Aravali",house:"",phone:"9419129902",email:"dheerajsharma@gmail.com",img:"",fatherName:" RAM PARSHAD",motherName:" KAILASH",address:"VILL. MEARTH, P.O. BUDHI, TESHIL & DISTT. KATHUA PIN. 184143"},
    {admissionNo:"2781",name:"MANIK BOURNEY",class:"X A",hostel:"Aravali",house:"",phone:"9697175274",email:"manikbourney@gmail.com",img:"",fatherName:" TILAK RAJ",motherName:" SAMBO DEVI",address:"WARD NO. 3 NEAR GMS DADWARA, P.O. BHADDU, TESHIL. BILLAWAR, DISTT. KATHUA PIN. 184203"},
    {admissionNo:"2855",name:"BHANU PARTAP",class:"X B",hostel:"Aravali",house:"",phone:"7889583545",email:"bhanupartap@gmail.com",img:"",fatherName:"LAJJAY RAM",motherName:"RANI DEVI",address:"VPO. NAGRI PAROLE TESHIL. NAGRI PAROLE, DISTT. KATHUA PIN. 184151"},
    {admissionNo:"2803",name:"DHEERAJ BHAGAT",class:"X B",hostel:"Aravali",house:"",phone:"9622320075",email:"dheerajbhagat@gmail.com",img:"",fatherName:"PARSHOTAM LAL",motherName:"ANJANA DEVI",address:"VILL. JAGATPUR MARHEEN, TESHIL. MARHEEN DISTT. KATHUA PIN. 184148"},
    {admissionNo:"4024",name:"DHRUB KESAR",class:"X B",hostel:"Aravali",house:"",phone:"6005268289",email:"dhrubkesar@gmail.com",img:"",fatherName:"PAWAN KUMAR",motherName:"SUSHMA DEVI",address:"VILL. KATHEEL DHANGU TESHIL.  MAJALTA DISTT. UDHAMPUR, P.O PEOUNI PIN. 182117"},
    {admissionNo:"2815",name:"GAJIT KUMAR",class:"X B",hostel:"Aravali",house:"",phone:"7006236041",email:"gajitkumar@gmail.com",img:"",fatherName:"NARESH KUMAR",motherName:"SONU DEVI",address:"WARD NO. 3 VILL SANOHI P.O. TAPPER, TESHIL BANI, DISTT. KATHUA PIN. 184206"},
    {admissionNo:"2854",name:"MAHEE BILLOWRIA",class:"X B",hostel:"Aravali",house:"",phone:"9697162402",email:"maheebillowria@gmail.com",img:"",fatherName:"HARDEEP SINGH",motherName:"NEERAJ BALA",address:"VILL. BARWAL, TESHIL & DISTT. KATHUA PIN. 184143"},
    {admissionNo:"2797",name:"RUDRA VERMA",class:"X B",hostel:"Aravali",house:"",phone:"6005238677",email:"rudraverma@gmail.com",img:"",fatherName:"RAKESH KUMAR",motherName:"REKHA RANI",address:"VPO. KHANPUR, TESHIL. MARHEEN, DISTT. KATHUA PIN. 184148"},
    {admissionNo:"2827",name:"SANGAM FACKOLU",class:"X B",hostel:"Aravali",house:"",phone:"9149710375",email:"sangamfackolu@gmail.com",img:"",fatherName:"MUKESH KUMAR",motherName:"VEENA DEVI",address:"WARD NO. 5, NEAR SHIV TEMPLE, VILL. THANA, P.O. PLASSI, TESHIL. BASOHLI DISTT. KATHUA PIN.184201"},
    {admissionNo:"2762",name:"ARYAN SATYAL",class:"XI C",hostel:"Aravali",house:"",phone:"6006512829",email:"aryansatyal@gmail.com",img:"",fatherName:"JEET KUMAR",motherName:"SUSHMA RANI",address:"R/O NANAN P/O GHATI TESHIL& DISTT. KATHUA PIN. 184201"},
    {admissionNo:"2733",name:"PUSHPAL SINGH",class:"XI B",hostel:"Aravali",house:"",phone:"9149664731",email:"pushpalsingh@gmail.com",img:"",fatherName:"SANJAY SINGH",motherName:"PINKY DEVI",address:"VPO. MALHAR TESHIL. LOHAI-MALHAR DISTT. KATHUA PIN. 184204"},
    {admissionNo:"2709",name:"RAJESH KATAL",class:"XI B",hostel:"Aravali",house:"",phone:"7298356210",email:"rajeshkatal@gmail.com",img:"",fatherName:"KAKA RAM KATAL",motherName:"KANTA DEVI",address:"VPO. WNO. POONDA TESHIL. MAHANPUR DISTT. KATHUA PIN. 184201"},
    {admissionNo:"2603",name:"DEEP KUMAR",class:"XII A",hostel:"Aravali",house:"",phone:"8082206251",email:"deepkumar@gmail.com",img:"",fatherName:"OM PRAKASH",motherName:"SUSHMA DEVI",address:"SERU BANI KATHUA 184206"},
    {admissionNo:"2866",name:"GOURAV SHARMA",class:"XII A",hostel:"Aravali",house:"",phone:"6005851908",email:"gouravsharma@gmail.com",img:"",fatherName:"SANJEEV KUMAR SHARMA",motherName:"PINKY SHARMA",address:"W.NO. VILL. BIGWAN P.O. JAKHWAR TESHIL & DISTT. KATHUA PIN. 184014"},
    {admissionNo:"2610",name:"KESHAV SHARMA",class:"XII A",hostel:"Aravali",house:"",phone:"9622394351",email:"keshavsharma@gmail.com",img:"",fatherName:"GULSHAN KUMAR",motherName:"SHIVANI SHARMA",address:"VPO. DHANNI BAKHTO (BHORTHAIN) TESHIL & DISTT. KATHUA PIN. 184143"},
    {admissionNo:"2600",name:"NEERAJ KUMAR",class:"XII A",hostel:"Aravali",house:"",phone:"7006766723",email:"neerajkumar@gmail.com",img:"",fatherName:"HANSRAJ",motherName:"PINKI DEVI",address:"JANOTA PO SUKRALA BILLAWAR KATHUA 184201"},
    {admissionNo:"2626",name:"VARUN THAKUR",class:"XII A",hostel:"Aravali",house:"",phone:"8493016411",email:"varunthakur@gmail.com",img:"",fatherName:"RAJINDER SINGH",motherName:"REVA DEVI",address:"CHUNERA MAHANUPUR KATHUA 184202"},
    {admissionNo:"2592",name:"BALJEET SINGH",class:"XII B",hostel:"Aravali",house:"",phone:"9797310808",email:"baljeetsingh@gmail.com",img:"",fatherName:"KAKU RAM",motherName:"GUDDO DEVI",address:"SALLON BASOHLI KATHUA 184201"},
    {admissionNo:"2640",name:"KARUN NAGOTRA",class:"XII B",hostel:"Aravali",house:"",phone:"7889526778",email:"karunnagotra@gmail.com",img:"",fatherName:"JAGDEV SINGH",motherName:"ANJU BALA",address:"MAHANPUR KATHUA 184201"},
    {admissionNo:"2665",name:"KASHORE SINGH",class:"XII B",hostel:"Aravali",house:"",phone:"9589420782",email:"kashoresingh@gmail.com",img:"",fatherName:"OMKAR CHAND",motherName:"NEELAM DEVI",address:"BILLAWAR KATHUA 184204"},
    {admissionNo:"2663",name:"PARSHANT KALANDRY",class:"XII B",hostel:"Aravali",house:"",phone:"9906278090",email:"parshantkalandry@gmail.com",img:"",fatherName:"DARSHAN KUMAR",motherName:"ANJU DEVI",address:"BANI KATHUA 184206"},
    {admissionNo:"2719",name:"MOHD ASHFAQ",class:"XI B",hostel:"Aravali",house:"",phone:"7006248376",email:"mohdashfaq@gmail.com",img:"",fatherName:"BIRU DIN",motherName:"KHURSHEDA AKHTER",address:"VILL. NAJOTE, PO. SUKRALA DEVI, TESHIL. MALHAR DISTT. KATHUA PIN. 184204"},
    {admissionNo:"2699",name:"PARUL VERMA",class:"XI A",hostel:"Aravali",house:"",phone:"8082056035",email:"parulverma@gmail.com",img:"",fatherName:"NEK RAM",motherName:"BHOLI DEVI",address:"VILL. GHODAL, BLOCK. MAHANPUR DISTT. KATHUA PIN. 184201"},
    {admissionNo:"2798",name:"MUKESH SINGH",class:"X A",hostel:"Aravali",house:"",phone:"9622050730",email:"mukeshsingh@gmail.com",img:"",fatherName:"DEALK RAM",motherName:"MEEMO DEVI",address:"WARD NO. 1 NEAR GHSS  BADNOTA, TESHIL. BILLAWAR BADNOTIA  DISTT. KATHUA PIN.184204"},
    {admissionNo:"2702",name:"ARNAV BILLAWRIA",class:"XI A",hostel:"Aravali",house:"",phone:"9419245990",email:"arnavbillawria@gmail.com",img:"",fatherName:"AMARJEET SINGH",motherName:"NAMRITA SLATHIA",address:"R/O. BUDHI BLOCK BARNOTI DISTT. KATHUA PIN. 184143"},
    {admissionNo:"2734",name:"RAVI KUMAR",class:"XI B ",hostel:"Aravali",house:"",phone:"9622359875",email:"ravikumar@gmail.com",img:"",fatherName:"JOGINDER PAUL",motherName:"GOURA DEVI",address:"VPO. GURHA KALIAL TESHIL. RAMKOT DISTT. KAHTUA PIN. 184210"},
    {admissionNo:"2749",name:"SHIVAM KUMAR",class:"XI B",hostel:"Aravali",house:"",phone:"7051490461",email:"shivamkumar@gmail.com",img:"",fatherName:"PALVINDER KUMAR",motherName:"CHANCHAL DEVI",address:"VPO. MARHEEN DISTT. KATHUA PIN. 184148"},
    {admissionNo:"2788",name:"NISHANT SHARMA",class:"X A",hostel:"Aravali",house:"",phone:"7298197597",email:"nishantsharma@gmail.com",img:"",fatherName:"PAWAN KUMAR",motherName:"KIRNA DEVI",address:"VPO. MAHANPUR , TESHIL. MAHANPUR, DISTT. KATHUA PIN. 184202"},
    {admissionNo:"2784",name:"SOURAV SINGH",class:"X B",hostel:"Aravali",house:"",phone:"9682574896",email:"souravsingh@gmail.com",img:"",fatherName:"RAMESH SINGH",motherName:"JYOTI DEVI",address:"VILL. PCAHI, TESHIL. BASOHLI, DISTT. KATHUA PIN. 184201"},
    {admissionNo:"5048",name:"KARAN",class:"XI C",hostel:"Aravali",house:"",phone:"7298425209",email:"karan@gmail.com",img:"",fatherName:"SOM RAJ",motherName:"SATYA DEVI",address:"R/O VPO BANI, TEHSIL BANI DISTT. KATHUA (JK)-184206"},
    {admissionNo:"2868",name:"AMARIS",class:"IX A",hostel:"Aravali",house:"",phone:"9541390200",email:"amaris@gmail.com",img:"",fatherName:"UDHAYBIR SINGH",motherName:"RAJNEE DEVI",address:"WARD NO 09, VPO & TEHSIL, NAGRI PAROLE, DISTT. KATHUA-184151"},
    {admissionNo:"2828",name:"RIDHAM LONI",class:"X A",hostel:"Aravali",house:"",phone:"6005238677",email:"ridhamloni@gmail.com",img:"",fatherName:"RAKESH KUMAR",motherName:"REKHA RANI",address:"VPO. KHANPUR, TESHIL. MARHEEN, DISTT. KATHUA PIN. 184148"},
  ];
  localStorage.setItem("students_seed_v2", JSON.stringify(students));
}

let leaves = JSON.parse(localStorage.getItem("leaves_v2") || "[]");
let timetable = JSON.parse(localStorage.getItem("timetable_v2") || "[]");
let tasks = JSON.parse(localStorage.getItem("tasks_v2") || "[]");

/* ==========================
   UTILS
========================== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const escapeHTML = (s="") => s.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));
function saveAll(){
  localStorage.setItem("leaves_v2", JSON.stringify(leaves));
  localStorage.setItem("timetable_v2", JSON.stringify(timetable));
  localStorage.setItem("tasks_v2", JSON.stringify(tasks));
}
function formatDate(ts){return new Date(ts).toLocaleDateString()}

/* ==========================
   SESSION / RBAC
========================== */
const SESSION_KEY = "jnv_session_v2";
let session = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
let currentUserRole = session?.role || "";
let currentStudent = session?.admissionNo || "";
let currentUserName = session?.name || "";

const roleBadge = $("#roleBadge");
const whoamiText = $("#whoamiText");

function setRBACVisibility(){
  // Hide all RBAC elements by default
  $$(".rbac").forEach(el => el.classList.add("hidden"));
  if(currentUserRole === "teacher1"){
    $$(".r-teacher1").forEach(el => el.classList.remove("hidden"));
  }else if(currentUserRole === "teacher2"){
    $$(".r-teacher2").forEach(el => el.classList.remove("hidden"));
    $("#exportStudentsBtn")?.classList.remove("hidden"); // teacher2 can export
  }
  // Student/Parent ‚Äì only Students section shown
  if(currentUserRole === "student" || currentUserRole === "parent"){
    showSection("students");
  }
  roleBadge.textContent = currentUserRole ? currentUserRole.toUpperCase() : "GUEST";
  whoamiText.textContent = currentUserName || "‚Äî";
}

/* ==========================
   LOGIN (basic hardening for demo)
========================== */
const MAX_ATTEMPTS = 5;
let attemptInfo = JSON.parse(localStorage.getItem("login_attempts") || '{"count":0,"until":0}');

function lockCheck(){
  const now = Date.now();
  if(attemptInfo.until && now < attemptInfo.until){
    return Math.ceil((attemptInfo.until - now)/1000);
  }
  return 0;
}
function registerFail(){
  const now = Date.now();
  attemptInfo.count = (attemptInfo.count||0) + 1;
  if(attemptInfo.count >= MAX_ATTEMPTS){
    attemptInfo.until = now + 60_000; // 1 minute lock
    attemptInfo.count = 0;
  }
  localStorage.setItem("login_attempts", JSON.stringify(attemptInfo));
}
function registerSuccess(){
  attemptInfo = {count:0, until:0};
  localStorage.setItem("login_attempts", JSON.stringify(attemptInfo));
}

$("#loginBtn").addEventListener("click", ()=>{
  const lockLeft = lockCheck();
  const err = $("#loginError");
  if(lockLeft){
    err.textContent = `Too many attempts. Try again in ${lockLeft}s.`;
    err.style.display = "block";
    return;
  }
  const email = $("#email").value.trim().toLowerCase();
  const pass = $("#password").value;
  const user = users.find(u => (u.email.toLowerCase()===email || u.admissionNo===email) && u.password===pass);
  if(!user){
    registerFail();
    err.textContent = "Invalid credentials.";
    err.style.display = "block";
    return;
  }
  registerSuccess();
  session = {role:user.role, admissionNo:user.admissionNo||"", name:user.name||user.email, email:user.email};
  localStorage.setItem(SESSION_KEY, JSON.stringify(session));
  currentUserRole = session.role;
  currentStudent = session.admissionNo || "";
  currentUserName = session.name || "";
  startApp();
});

/* ==========================
   NAV + DRAWER
========================== */
const drawer = $("#drawer");
$("#openDrawerBtn").addEventListener("click", ()=> drawer.classList.toggle("open"));
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") drawer.classList.remove("open");
});
drawer.addEventListener("click", (e)=>{
  if(e.target.matches("button[data-section]")){
    showSection(e.target.getAttribute("data-section"));
    drawer.classList.remove("open");
  }
});

function showSection(id){
  $$(".section").forEach(s=>s.classList.remove("active"));
  $("#"+id).classList.add("active");
}

/* ==========================
   STUDENTS ‚Äì virtualized grid with paging
========================== */
const PAGE_SIZE = 8;
let filteredStudents = [];
let pageIndex = 0;

function filterStudents(){
  const q = $("#studentSearch").value.trim().toLowerCase();
  const hostel = $("#hostelFilter").value;
  const house = $("#houseFilter").value;

  filteredStudents = students.filter(s=>{
    if((currentUserRole==="student"||currentUserRole==="parent") && s.admissionNo!==currentStudent) return false;
    if(hostel && s.hostel !== hostel) return false;
    if(house && s.house !== house) return false;
    if(!q) return true;
    return s.name.toLowerCase().includes(q) || s.admissionNo.toLowerCase().includes(q);
  });

  pageIndex = 0;
  renderStudentsPage();
}

function renderStudentsPage(){
  const grid = $("#studentGrid");
  if(pageIndex === 0) grid.innerHTML = "";

  const start = pageIndex * PAGE_SIZE;
  const slice = filteredStudents.slice(start, start + PAGE_SIZE);
  slice.forEach(s=>grid.appendChild(studentCard(s)));

  pageIndex++;
  const hasMore = (pageIndex * PAGE_SIZE) < filteredStudents.length;
  $("#loadMoreBtn").classList.toggle("hidden", !hasMore);
}

function studentCard(s){
  const card = document.createElement("div");
  card.className = "card";
  const partialCount = leaves.filter(l=>l.admissionNo===s.admissionNo && l.type==="partial").length;
  const fullCount = leaves.filter(l=>l.admissionNo===s.admissionNo && l.type==="full").length;

  card.innerHTML = `
    <div class="avatar">${ s.img ? `<img src="${escapeHTML(s.img)}" alt="${escapeHTML(s.name)}">` : "üßë" }</div>
    <h3>${escapeHTML(s.name)}</h3>
    <div class="meta">Admission No: ${escapeHTML(s.admissionNo)}</div>
    <div class="kv">
      <div>Class</div><div>${escapeHTML(s.class)}</div>
      <div>Hostel</div><div>${escapeHTML(s.hostel)}</div>
      <div>House</div><div>${escapeHTML(s.house)}</div>
      <div>Phone</div><div>${escapeHTML(s.phone)}</div>
      <div>Father</div><div>${escapeHTML(s.fatherName)}</div>
      <div>Mother</div><div>${escapeHTML(s.motherName)}</div>
      <div>Address</div><div>${escapeHTML(s.address)}</div>
      <div>Leaves</div><div>Partial: ${partialCount} | Full: ${fullCount}</div>
    </div>
  `;
  if(currentUserRole==="teacher1"){
    const actions = document.createElement("div");
    actions.className = "actions";
    const btn = document.createElement("button");
    btn.className = "toolbar-btn";
    btn.textContent = "Download Leaves";
    btn.addEventListener("click", ()=>downloadStudentLeave(s.admissionNo));
    actions.appendChild(btn);
    card.appendChild(actions);
  }
  return card;
}

$("#studentSearch").addEventListener("input", debounce(filterStudents, 200));
$("#hostelFilter").addEventListener("change", filterStudents);
$("#houseFilter").addEventListener("change", filterStudents);
$("#loadMoreBtn").addEventListener("click", renderStudentsPage);

function debounce(fn, ms){
  let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }
}

/* ==========================
   LEAVES
========================== */
function searchLeaveStudent(){
  const val = $("#leaveSearchInput").value.trim().toLowerCase();
  const list = students.filter(s=> s.name.toLowerCase().includes(val) || s.admissionNo.toLowerCase().includes(val));
  const sel = $("#leaveStudent");
  sel.innerHTML = "";
  list.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.admissionNo;
    opt.textContent = `${s.name} (${s.admissionNo})`;
    sel.appendChild(opt);
  });
}

function applyLeave(){
  const admissionNo = $("#leaveStudent").value;
  const type = document.querySelector('input[name="leaveType"]:checked').value;
  const from = $("#leaveFrom").value;
  const to = $("#leaveTo").value;
  const reason = $("#leaveReason").value.trim();
  const parent = $("#leaveParent").value.trim();
  if(!admissionNo || !from || !to){ alert("Fill all fields"); return; }

  leaves.push({admissionNo, type, from, to, reason, parent, date: formatDate(Date.now())});
  saveAll();
  displayLeaveHistory();
  filterStudents();
}

function displayLeaveHistory(){
  const t = $("#leaveHistory");
  const hdrAction = currentUserRole==="teacher1" ? "<th>Action</th>" : "";
  t.innerHTML = `<tr><th>Admission No</th><th>Type</th><th>From</th><th>To</th><th>Reason</th><th>Parent</th><th>Date Applied</th>${hdrAction}</tr>`;
  leaves.forEach((l,idx)=>{
    if((currentUserRole==="student"||currentUserRole==="parent") && l.admissionNo !== currentStudent) return;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHTML(l.admissionNo)}</td>
      <td>${escapeHTML(l.type)}</td>
      <td>${escapeHTML(l.from)}</td>
      <td>${escapeHTML(l.to)}</td>
      <td>${escapeHTML(l.reason||"")}</td>
      <td>${escapeHTML(l.parent||"")}</td>
      <td>${escapeHTML(l.date)}</td>
    `;
    if(currentUserRole==="teacher1"){
      const td = document.createElement("td");
      const btn = document.createElement("button");
      btn.className = "warn";
      btn.textContent = "Delete";
      btn.addEventListener("click", ()=>deleteLeave(idx));
      td.appendChild(btn);
      tr.appendChild(td);
    }
    t.appendChild(tr);
  });
}

function deleteLeave(index){
  if(!confirm("Delete this leave record?")) return;
  leaves.splice(index,1);
  saveAll();
  displayLeaveHistory();
  filterStudents();
}

function downloadLeaveHistory(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(leaves);
  XLSX.utils.book_append_sheet(wb, ws, "Leaves");
  XLSX.writeFile(wb, "LeaveHistory.xlsx");
}

// Ensure a robust downloadStudentLeave available (overrides any previous)
function downloadStudentLeave(admissionNo){
  try{
    const sLeaves = leaves.filter(l=>l.admissionNo===admissionNo);
    if(!sLeaves || sLeaves.length === 0){
      alert("No leave records found for this student.\n‡§á‡§∏ ‡§õ‡§æ‡§§‡•ç‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§Ö‡§µ‡§ï‡§æ‡§∂ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§");
      return;
    }
    const wb = XLSX.utils.book_new();
    // Normalize objects to ensure consistent columns
    const normalized = sLeaves.map(l => ({
      admissionNo: l.admissionNo || "",
      type: l.type || "",
      from: l.from || "",
      to: l.to || "",
      reason: l.reason || "",
      parent: l.parent || "",
      dateApplied: l.date || ""
    }));
    const ws = XLSX.utils.json_to_sheet(normalized);
    XLSX.utils.book_append_sheet(wb, ws, "Leaves");
    XLSX.writeFile(wb, `Leaves_${admissionNo}.xlsx`);
  }catch(err){
    console.error("downloadStudentLeave error:", err);
    alert("Error downloading leaves.\n‡§Ö‡§µ‡§ï‡§æ‡§∂ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§");
  }
}

/* ==========================
   HOSTEL TASKS
========================== */
function addTask(){
  const hostel = $("#taskHostel").value;
  const date = $("#taskDate").value;
  const desc = $("#taskDesc").value.trim();
  if(!hostel || !date || !desc){ alert("Fill all fields"); return; }
  tasks.push({hostel, date, desc});
  saveAll(); displayTasks();
}
function displayTasks(){
  const t = $("#taskTable");
  const hdrAction = currentUserRole==="teacher1" ? "<th>Action</th>" : "";
  t.innerHTML = `<tr><th>Hostel</th><th>Date</th><th>Task</th>${hdrAction}</tr>`;
  tasks.forEach((task,idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHTML(task.hostel)}</td><td>${escapeHTML(task.date)}</td><td>${escapeHTML(task.desc)}</td>`;
    if(currentUserRole==="teacher1"){
      const td = document.createElement("td");
      const btn = document.createElement("button");
      btn.className="warn"; btn.textContent="Delete";
      btn.addEventListener("click", ()=>deleteTask(idx));
      td.appendChild(btn); tr.appendChild(td);
    }
    t.appendChild(tr);
  });
}
function deleteTask(index){
  if(!confirm("Delete this task?")) return;
  tasks.splice(index,1);
  saveAll(); displayTasks();
}
function downloadTasks(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(tasks);
  XLSX.utils.book_append_sheet(wb, ws, "Tasks");
  XLSX.writeFile(wb, "HostelTasks.xlsx");
}

/* ==========================
   TIMETABLE (Teacher2)
========================== */
function addTimetable(){
  if(currentUserRole !== "teacher2"){ alert("Only Teacher2 can add timetable"); return; }
  const cls = $("#ttClass").value;
  const date = $("#ttDate").value;
  const time = $("#ttTime").value;
  const topic = $("#ttTopic").value.trim();
  const teacher = $("#ttTeacher").value.trim();
  if(!date || !time || !topic || !teacher){ alert("Fill all fields"); return; }
  timetable.push({cls, date, time, topic, teacher});
  saveAll();
  displayTimetable();
}
function displayTimetable(){
  const t = $("#timetableTable");
  t.innerHTML = `<tr><th>Class</th><th>Date</th><th>Time</th><th>Topic</th><th>Teacher</th><th>Action</th></tr>`;
  timetable.forEach((row, i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHTML(row.cls)}</td>
      <td>${escapeHTML(row.date)}</td>
      <td>${escapeHTML(row.time)}</td>
      <td>${escapeHTML(row.topic)}</td>
      <td>${escapeHTML(row.teacher)}</td>
      <td>${ currentUserRole==="teacher2" ? `<button class="warn" data-del="${i}">Delete</button>` : "-" }</td>
    `;
    t.appendChild(tr);
  });
  t.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      if(currentUserRole !== "teacher2"){ alert("Only Teacher2 can delete timetable"); return; }
      if(!confirm("Delete this timetable entry?")) return;
      const idx = +e.currentTarget.getAttribute("data-del");
      timetable.splice(idx,1);
      saveAll(); displayTimetable();
    });
  });
}
function downloadTimetable(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(timetable);
  XLSX.utils.book_append_sheet(wb, ws, "Timetable");
  XLSX.writeFile(wb, "Timetable.xlsx");
}

/* ==========================
   IMPORT / EXPORT STUDENTS
========================== */
$("#uploadBtn").addEventListener("click", ()=> $("#uploadExcel").click());
$("#uploadExcel").addEventListener("change", (event)=>{
  const file = event.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, {type:"array"});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws);
    // Expect headers matching keys of student object; ignore unknown fields
    rows.forEach(r=>{
      const s = {
        admissionNo: r.admissionNo || r["Admission No"] || r["admission_no"] || "",
        name: r.name || r["Name"] || "",
        class: r.class || r["Class"] || "",
        hostel: r.hostel || r["Hostel"] || "",
        house: r.house || r["House"] || "",
        phone: r.phone || r["Phone"] || "",
        email: r.email || r["Email"] || "",
        img: r.img || r["Image"] || "",
        fatherName: r.fatherName || r["Father Name"] || "",
        motherName: r.motherName || r["Mother Name"] || "",
        address: r.address || r["Address"] || ""
      };
      if(s.admissionNo) students.push(s);
    });
    localStorage.setItem("students_seed_v2", JSON.stringify(students));
    filterStudents();
    alert("Students uploaded.");
  };
  reader.readAsArrayBuffer(file);
});
$("#exportStudentsBtn").addEventListener("click", ()=>{
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(students);
  XLSX.utils.book_append_sheet(wb, ws, "Students");
  XLSX.writeFile(wb, "Students.xlsx");
});

/* ==========================
   LOAD STUDENT DATA BUTTON (3 confirmations, bilingual prompts)
   This is the new functionality requested: it saves the in-code `students` array
   into localStorage key `students_seed_v2` after asking three confirmations.
========================== */
$("#loadStudentDataBtn").addEventListener("click", ()=>{
  // Confirmation 1
  const c1 = confirm("Are you sure you want to load student data? / ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§õ‡§æ‡§§‡•ç‡§∞ ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?");
  if(!c1) return;
  // Confirmation 2
  const c2 = confirm("This will replace the current student list in local storage. Continue? / ‡§Ø‡§π ‡§≤‡•ã‡§ï‡§≤ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§Æ‡•á‡§Ç ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§õ‡§æ‡§§‡•ç‡§∞ ‡§∏‡•Ç‡§ö‡•Ä ‡§ï‡•ã ‡§¨‡§¶‡§≤ ‡§¶‡•á‡§ó‡§æ‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç?");
  if(!c2) return;
  // Confirmation 3
  const c3 = confirm("Final confirmation ‚Äî load data now? / ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‚Äî ‡§ï‡•ç‡§Ø‡§æ ‡§Ö‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç?");
  if(!c3) return;

  try{
    // Save only student list to the same key used in the app.
    localStorage.setItem("students_seed_v2", JSON.stringify(students));
    // Re-load into the running variable in case user had navigated earlier.
    students = JSON.parse(localStorage.getItem("students_seed_v2") || "[]");
    // Refresh UI (students list)
    filterStudents();
    // Show success bilingual message
    alert("‚úÖ Student data loaded successfully! / ‡§õ‡§æ‡§§‡•ç‡§∞ ‡§°‡•á‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ!");
  }catch(err){
    console.error(err);
    alert("Error saving student data. / ‡§õ‡§æ‡§§‡•ç‡§∞ ‡§°‡•á‡§ü‡§æ ‡§∏‡§π‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§");
  }
});

/* ==========================
   DOWNLOAD BUTTONS
========================== */
$("#downloadLeaveHistoryBtn").addEventListener("click", downloadLeaveHistory);
$("#downloadTasksBtn").addEventListener("click", downloadTasks);
$("#downloadTimetableBtn").addEventListener("click", downloadTimetable);

/* ==========================
   BIND ACTIONS
========================== */
$("#applyLeaveBtn").addEventListener("click", applyLeave);
$("#leaveSearchInput").addEventListener("input", debounce(searchLeaveStudent, 200));
$("#addTaskBtn").addEventListener("click", addTask);
$("#addTimetableBtn").addEventListener("click", addTimetable);

/* ==========================
   LOGOUT
========================== */
$("#logoutBtn").addEventListener("click", ()=>{
  localStorage.removeItem(SESSION_KEY);
  location.reload();
});

/* ==========================
   START APP
========================== */
function startApp(){
  // Toggle views
  $("#loginView").style.display = "none";
  $("#app").style.display = "block";

  // RBAC
  setRBACVisibility();

  // Initial renders
  filterStudents();
  displayLeaveHistory();
  displayTimetable();
  displayTasks();

  // Populate leave student list by default
  searchLeaveStudent();
}

/* On load: resume session if present */
if(session && session.role){
  startApp();
}else{
  $("#loginView").style.display = "grid";
}

/* ==========================
   GLOBAL EXPOSE (Excel helpers used in cards)
========================== */
window.downloadStudentLeave = downloadStudentLeave;
  <!-- ‚úÖ FIX: working mobile-friendly Load Student Data -->
<script>
function loadStudentData() {
  // 3 bilingual confirmations
  if (!confirm("Are you sure you want to load student data?\n‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§Ü‡§™ ‡§õ‡§æ‡§§‡•ç‡§∞ ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;
  if (!confirm("This will overwrite existing data.\n‡§Ø‡§π ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§Ö‡§ß‡§ø‡§≤‡•á‡§ñ‡§ø‡§§ ‡§ï‡§∞ ‡§¶‡•á‡§ó‡§æ‡•§")) return;
  if (!confirm("Final confirmation ‚Äî proceed?\n‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‚Äî ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;

  try {
    // Use the same students array that already exists in your code
    if (students && Array.isArray(students) && students.length > 0) {
      localStorage.setItem("students_seed_v2", JSON.stringify(students));
      alert("‚úÖ Student data loaded successfully!\n‡§õ‡§æ‡§§‡•ç‡§∞ ‡§°‡•á‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ!");

      // Immediately refresh the list
      if (typeof renderStudentList === "function") {
        renderStudentList(); // update without reload
      } else {
        location.reload();   // fallback if no render function found
      }
    } else {
      alert("‚ö†Ô∏è No student data found in code.\n‡§ï‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§õ‡§æ‡§§‡•ç‡§∞ ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§");
    }
  } catch (e) {
    console.error("Error loading data:", e);
    alert("‚ùå Error loading data.\n‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§");
  }

</script>
</body>
</html>

